---
layout: post
title: Что такое оконные функции в SQL. Window Functions
comments: False
category: sql
tags: sql
---

<a href="https://andreyex.ru/bazy-dannyx/baza-dannyx-mysql/mysql-okonnye-funktsii/" rel="nofollow" target="_blank">Источник</a>

Оконные функции позволяют решать проблемы запросов новыми, более простыми способами и с более высокой производительностью.

Предположим, у нас есть таблица sales, в которой хранятся данные о продажах по сотрудникам и финансовым годам следующим образом:

```sql
CREATE TABLE sales(
sales_employee VARCHAR(50) NOT NULL,
fiscal_year INT NOT NULL,
sale DECIMAL(14,2) NOT NULL,
PRIMARY KEY(sales_employee,fiscal_year)
);

INSERT INTO sales(sales_employee,fiscal_year,sale)
VALUES('AndreyEx',2019,50000),
('AndreyEx',2017,44000),
('AndreyEx',2018,35000),
('Angel',2019,35000),
('Angel',2018,30000),
('Angel',2017,28000),
('Master',2019,32000),
('Master',2018,27000),
('Master',2017,25000);

SELECT * FROM sales;
```

<img src="/assets/img/2020-11-16-ms-sql-server/1.png">

Вероятно, легче понять оконные функции, если начать с агрегатных функций.

Агрегирующие функции суммируют данные из нескольких строк в одну строку результатов. Например, следующая функция ```SUM()``` возвращает общие продажи всех сотрудников за записанные годы:

```sql
SELECT
SUM(sale)
FROM
sales;
```

Предложение ```GROUP BY``` позволяет применять агрегатные функции к подмножеству строк. Например, вы можете рассчитать общий объем продаж по финансовым годам:

```sql
SELECT fiscal_year, SUM(sale)
FROM sales
GROUP BY fiscal_year;
```

<img src="/assets/img/2020-11-16-ms-sql-server/2.png">

В обоих примерах агрегатные функции уменьшают количество строк, возвращаемых запросом.

Подобно агрегатным функциям с предложением GROUP BY, оконные функции также работают с подмножеством строк, но они не уменьшают количество строк, возвращаемых запросом.

Например, следующий запрос возвращает продажи для каждого сотрудника вместе с общими продажами сотрудников по финансовым годам:

```sql
SELECT fiscal_year, sales_employee, sale,
SUM(sale) OVER (PARTITION BY fiscal_year) total_sales
FROM sales;
```

<img src="/assets/img/2020-11-16-ms-sql-server/3.png">

В этом примере функция ```SUM()``` работает как оконная функция, которая работает с набором строк, определенных содержимым предложения ```OVER```. Набор строк, к которым ```SUM()``` применяется функция, называется окном.

Функция ```SUM()``` окна сообщает не только общий объем продаж по финансовым годам, как это делается в запросе с предложением ```GROUP BY```, но также и результат в каждой строке, а не общее количество возвращенных строк.

Обратите внимание , что окно функции выполняются на наборе результатов после того, как все ```JOIN```, ```WHERE```, ```GROUP BY``` и положения HAVING и до ```ORDER BY```, ```LIMIT``` и ```SELECT DISTINCT```.